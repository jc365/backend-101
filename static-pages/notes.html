<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Repositorio Notas Markdown</title>

    <!-- Librer√≠as -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mark.js/dist/mark.min.js"></script>

    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 20px;
        background: #f7f7fa;
      }
      h1 {
        font-weight: 400;
      }
      #searchBar {
        display: flex;
        gap: 10px;
      }
      #searchInput {
        flex: 1 0 200px;
        padding: 7px 12px;
        border: 1px solid #bfc6d1;
        border-radius: 6px;
        font-size: 1em;
      }
      .btnSearch {
        padding: 7px 16px;
        border: none;
        background: #3250dd;
        color: #fff;
        font-size: 1em;
        border-radius: 6px;
        cursor: pointer;
      }
      #btnSearch:active {
        background: #263d9a;
      }
      #results {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        list-style: none;
        padding: 0;
        min-height: 42px;
      }
      .result-card {
        background: #b9dbe3;
        border-radius: 8px;
        min-width: 210px;
        max-width: 320px;
        padding: 14px 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        cursor: pointer;
        transition: box-shadow 0.15s;
        border: 1px solid #e2e8f0;
        font-size: 1.07em;
      }
      .result-card:hover {
        box-shadow: 0 4px 16px rgba(32, 64, 220, 0.15);
        border-color: #b0c4f7;
        background: #eaf0ff;
      }
      .result-card mark {
        background: #ffe570;
        padding: 1px 2px;
        border-radius: 3px;
      }

      /* Contenedor para paginacion y upload */
      #bottomBar {
        display: flex;
        align-items: center;
        gap: 20px; /* espacio peque√±o entre bloques */
        flex-wrap: wrap; /* para evitar overflow horizontal */
      }

      /* Bloque paginacion */
      #paginationBlock {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 12px 18px;
        min-width: 320px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      #paginationBlock button {
        min-width: 80px;
        padding: 6px 12px;
        font-size: 1em;
        cursor: pointer;
        border-radius: 6px;
        background-color: #3250dd;
        color: white;
        border: none;
        transition: background-color 0.3s ease;
      }
      #paginationBlock button:disabled {
        background-color: #9aa9d6;
        cursor: default;
      }
      #paginationBlock button:hover:not(:disabled) {
        background-color: #263d9a;
      }
      #paginationBlock input[type="number"] {
        border: 1px solid #bfc6d1;
        border-radius: 6px;
        height: 30px;
      }

      /* Bloque upload */
      #uploadBlock {
        max-width: 580px;
        flex-grow: 1;
        align-items: center;
        gap: 10px;
        box-sizing: border-box;
      }
      #uploadBlock #actions {
        flex-shrink: 0;
      }
      #uploadBlock button#uploadBtn {
        white-space: nowrap;
        cursor: pointer;
      }
      #uploadBlock label {
        font-weight: 600;
        font-size: 1em;
        color: #004085;
        user-select: none;
        white-space: nowrap;
      }
      /* Clase para ocultar el bot√≥n manteniendo el espacio */
      .hidden-button {
        visibility: hidden;
        pointer-events: none;
        width: 0;
        margin: 0;
        padding: 0;
      }

      /* Opcional: estilizar bot√≥n interno del input file en Chrome/Safari */
      #uploadBlock input[type="file"]::-webkit-file-upload-button {
        padding: 6px 12px;
        border-radius: 6px;
        background-color: #3250dd;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      #uploadBlock input[type="file"]::-webkit-file-upload-button:hover {
        background-color: #263d9a;
      }

      /* VISOR */
      #viewer {
        margin-top: 38px;
        padding: 25px 18px;
        border: 1px solid #eee;
        border-radius: 10px;
        min-height: 170px;
        background: #fff;
        box-shadow: 0 4px 12px #eee;
        max-width: 900px;
        font-size: 1.07em;
        word-break: break-word;
        overflow-x: auto;
        position: relative; /* Para posicionar botones */
      }

      /* Botonera posici√≥n esquina superior derecha */
      .botonera {
        position: absolute;
        top: 10px;
        right: 10px;
        margin: 6px;
        display: flex;
        gap: 10px;
        z-index: 1000;
      }
      .botonera button {
        background-color: #3250dd;
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      .botonera button:hover {
        background-color: #263d9a;
      }

      /* Estilo para tags */
      .tags {
        margin-bottom: 14px;
      }
      .tags .tag {
        display: inline-block;
        background-color: #cce5ff;
        color: #004085;
        padding: 3px 8px;
        margin: 0 6px 6px 0;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
        user-select: none;
      }

      /* Estilos para mark.js resaltado (contenido) */
      mark {
        background-color: #ffe570;
        padding: 1px 2px;
        border-radius: 3px;
      }

      /* √Årea de upload */
      #upFiles {
        margin-top: 10px;
      }
      #actions {
        margin-bottom: 14px;
      }
      #status div {
        margin-bottom: 4px;
        font-family: monospace;
      }

      /* Mensajes de estado */
      #mensaje {
        margin-bottom: 12px;
        font-weight: bold;
      }
      #mensaje.success {
        color: green;
      }
      #mensaje.error {
        color: red;
      }

      @media (max-width: 650px) {
        #viewer,
        #results {
          max-width: 99vw;
        }
        .result-card {
          min-width: 95vw;
          max-width: 99vw;
        }
        #bottomBar {
          flex-direction: column;
          gap: 10px;
        }
        #paginationBlock,
        #uploadBlock {
          min-width: auto;
          max-width: 100%;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <h1>Repositorio de Notas Markdown üìì (v2.0)</h1>

    <div id="searchBar">
      <input
        type="text"
        id="searchInput"
        placeholder="Search in Notes (title and content). Put your text and <Intro> or click at button <Search> "
        autocomplete="off"
      />
      <button id="btnSearch" class="btnSearch">Search</button>
      <button id="btnCleanAndSearch" class="btnSearch">Clear + Search</button>
    </div>

    <div id="bottomBar">
      <div id="paginationBlock">
        <button id="btnPrev" disabled>Anterior</button>

        <span>Page</span>
        <input
          type="number"
          id="pageInput"
          style="width: 40px; font-size: 1em; text-align: center"
        />
        <span id="pageTotal">/ 0</span>
        <span> (total notes found <span id="totalItems">0</span> )</span>
        
        <button id="btnNext" disabled>Siguiente</button>
      </div>

      <div id="uploadBlock">
        <label for="upFiles">Upload al Repositorio ...</label>

        <input
          id="upFiles"
          type="file"
          accept=".md,.txt"
          multiple
          onchange="selectFiles()"
        />

        <div id="actions">
          <button id="uploadBtn" onclick="startUpload()" class="hidden-button">
            Subir ficheros
          </button>
        </div>
      </div>
    </div>

    <div id="status"></div>

    <!-- Contenedor para mensajes de respuesta -->
    <div id="mensaje"></div>

    <ul id="results"></ul>

    <div id="viewer">
      <em>Visor: Selecciona una nota para verla aqu√≠‚Ä¶</em>
    </div>

    <script>
      const BACKEND = "http://localhost:5050";
      // const BACKEND = "https://backend-101-hu0a.onrender.com";
      const URL_PATH = "/api/v1/notes";
      const PAGE_SIZE = 4;
      let currentPage = 1;
      let lastQuery = "";

      const searchInput = document.getElementById("searchInput");
      const btnSearch = document.getElementById("btnSearch");
      const resultsUl = document.getElementById("results");
      const viewer = document.getElementById("viewer");

      // Variables subida
      let selectedFiles = [];

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") searchNotes();
      });

      btnSearch.addEventListener("click", (e) => {
        e.preventDefault();
        searchNotes();
      });

      btnCleanAndSearch.addEventListener("click", (e) => {
        e.preventDefault();
        cleanAndSearch();
      });

      // Gesti√≥n selecci√≥n ficheros (upload)
      function selectFiles() {
        const input = document.getElementById("upFiles");
        const actions = document.getElementById("actions");
        const status = document.getElementById("status");

        selectedFiles = Array.from(input.files);
        toggleUploadButton(selectedFiles.length > 0);

        // Limpiar status al seleccionar nuevos ficheros
        status.innerHTML = "";
      }

      function toggleUploadButton(show) {
        const uploadBtn = document.getElementById("uploadBtn");
        if (show) {
          uploadBtn.classList.remove("hidden-button");
        } else {
          uploadBtn.classList.add("hidden-button");
        }
      }

      // Funci√≥n para mostrar mensajes
      function mostrarMensaje(texto, tipo = "success") {
        const mensajeElem = document.getElementById("mensaje");
        if (!mensajeElem) return;
        mensajeElem.textContent = texto;
        mensajeElem.className = tipo; // "success" o "error"

        // Ocultar mensaje luego de 5 segundos
        setTimeout(() => {
          mensajeElem.textContent = "";
          mensajeElem.className = "";
        }, 5000);
      }

      // Subir ficheros seleccionados
      async function startUpload() {
        const status = document.getElementById("status");
        status.innerHTML = "";

        for (const file of selectedFiles) {
          try {
            const content = await file.text();

            const doc = {
              filename: file.name,
              content,
            };

            const res = await fetch(`${BACKEND}${URL_PATH}/upload`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(doc),
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            if (data.status === "success") {
              const operacion = data.operacion;
              if (operacion === "insert") {
                mostrarMensaje(
                  `Nota "${doc.filename}" creada correctamente.`,
                  "success"
                );
              } else if (operacion === "update") {
                mostrarMensaje(
                  `Nota "${doc.filename}" actualizada correctamente.`,
                  "success"
                );
              }

              status.innerHTML += `<div style="color:green;">‚úî ${file.name} subido correctamente</div>`;
            } else {
              mostrarMensaje(
                `Error con "${doc.filename}": ${
                  data.message || "Error desconocido"
                }`,
                "error"
              );
              status.innerHTML += `<div style="color:red;">‚úò Error con ${
                file.name
              }: ${data.message || "Error desconocido"}</div>`;
            }
          } catch (e) {
            mostrarMensaje(`Error con "${file.name}": ${e.message}`, "error");
            status.innerHTML += `<div style="color:red;">‚úò Error con ${file.name}: ${e.message}</div>`;
            console.error(`Error subiendo ${file.name}:`, e);
          }
        }

        // Limpiar selecci√≥n y esconder bot√≥n
        selectedFiles = [];
        document.getElementById("upFiles").value = "";
        toggleUploadButton(false);
      }

      // Funci√≥n que resalta texto en t√≠tulos (texto plano)
      function highlight(text, query) {
        if (!query) return text;
        let terms = query.toLowerCase().split(/\s+/).filter(Boolean);
        let re = new RegExp(
          "(" +
            terms
              .map((t) => t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"))
              .join("|") +
            ")",
          "gi"
        );
        return text.replace(re, "<mark>$1</mark>");
      }

      function cleanAndSearch() {
        searchInput.value = "";
        searchNotes();
      }

      // Funci√≥n de b√∫squeda de notas
      function searchNotes(url) {
        let query = "";
        if (!url) {
          query = searchInput.value.trim();
          url =
            `${URL_PATH}/search?&mode=page&page_size=4&q=` +
            encodeURIComponent(query);
          document.getElementById("status").innerHTML = "";
        }
        // resultsUl.innerHTML = "<li><em>Cargando‚Ä¶</em></li>";
        viewer.innerHTML =
          `<em>Selecciona una nota para verla aqu√≠‚Ä¶</em>
           <hr><em>Backend para llamadas a APIs [ ${BACKEND}</em>
           <br><em> ....${url} ]</em>`;

        fetch(`${BACKEND}${url}`)
          .then((r) => r.json())
          .then((result) => {
            lastQuery = query;
            resultsUl.innerHTML = "";
            if (!result.data || result.data.length === 0) {
              resultsUl.innerHTML = "<li><em>No hay resultados.</em></li>";
              return;
            }

            result.data.forEach((note) => {
              const li = document.createElement("li");
              li.className = "result-card";
              li.innerHTML = highlight(note.title, query);
              li.dataset.id = note._id;
              li.onclick = () => loadNote(note._id);
              resultsUl.appendChild(li);
            });

            renderPagination(result.pagination, result.links);
          })
          .catch((err) => {
            resultsUl.innerHTML = "<li><em>Error buscando notas‚Ä¶</em></li>";
            console.error(err);
          });
      }

      // Paginaci√≥n
      function renderPagination(pag, links) {
        const btnPrev = document.getElementById("btnPrev");
        const btnNext = document.getElementById("btnNext");
        const pageInput = document.getElementById("pageInput");
        const pageTotal = document.getElementById("pageTotal");
        const totalItems = document.getElementById("totalItems");

        currentPage = links.self;
        btnPrev.disabled = !links.prev;
        btnNext.disabled = !links.next;

        pageInput.value = pag.page;
        pageInput.min = 1;
        pageInput.max = pag.total_pages;
        pageTotal.textContent = `/ ${pag.total_pages}`;
        totalItems.textContent = pag.total;

        btnPrev.onclick = links.prev ? () => searchNotes(links.prev) : null;
        btnNext.onclick = links.next ? () => searchNotes(links.next) : null;

        pageInput.onchange = () => {
          let desiredPage = parseInt(pageInput.value);
          searchNotes(links.last.replace(/(page=)(\d+)/, `$1${desiredPage}`));
        };
      }

      // Carga nota y la muestra con resaltado en t√≠tulo y contenido
      function loadNote(id) {
        viewer.innerHTML = "<em>Cargando nota‚Ä¶</em>";
        fetch(`${BACKEND}${URL_PATH}/${id}`)
          .then((res) => res.json())
          .then((result) => {
            const note = result.data;
            const tagsHtml =
              note.tags && note.tags.length > 0
                ? `<div class="tags">${note.tags
                    .map((tag) => `<span class="tag">${tag}</span>`)
                    .join("")}</div>`
                : "";

            viewer.innerHTML = `
              <div class="botonera">
                <button id="editTitleBtn">Editar t√≠tulo</button>
                <button id="deleteNoteBtn">Borrar nota</button>
                <button id="downloadMdBtn">Descargar .md</button>
              </div>
              ${tagsHtml}
              <div id="noteContent">${marked.parse(note.content)}</div>
            `;

            // Descargar .md
            document.getElementById("downloadMdBtn").onclick = function () {
              const blob = new Blob([note.content], { type: "text/markdown" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download =
                note.filename || note.title.replace(/\s+/g, "_") + ".md";
              document.body.appendChild(a);
              a.click();
              setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              }, 100);
            };

            // EDITAR T√çTULO
            document.getElementById("editTitleBtn").onclick = () => {
              const newTitle = prompt("Editar t√≠tulo de la nota:", note.title);
              if (
                newTitle &&
                newTitle.trim() !== "" &&
                newTitle !== note.title
              ) {
                fetch(`${BACKEND}${URL_PATH}/${id}`, {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ title: newTitle.trim() }),
                })
                  .then((res) => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                  })
                  .then((updatedNote) => {
                    mostrarMensaje("T√≠tulo actualizado", "success");
                    loadNote(id); // recarga nota con t√≠tulo editado
                    searchNotes(currentPage); // refresca la lista para mostrar nuevo t√≠tulo
                  })
                  .catch((err) => {
                    mostrarMensaje("Error actualizando t√≠tulo", "error");
                    console.error(err);
                  });
              }
            };

            // BORRAR NOTA
            document.getElementById("deleteNoteBtn").onclick = () => {
              if (
                confirm(
                  "¬øEst√°s seguro de querer borrar esta nota? Esta acci√≥n no se puede deshacer."
                )
              ) {
                fetch(`${BACKEND}${URL_PATH}/${id}`, {
                  method: "DELETE",
                })
                  .then((res) => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    mostrarMensaje("Nota borrada correctamente", "success");
                    viewer.innerHTML =
                      "<em>Selecciona una nota para verla aqu√≠‚Ä¶</em>";
                    searchNotes(currentPage); // refresca listado
                  })
                  .catch((err) => {
                    mostrarMensaje("Error borrando la nota", "error");
                    console.error(err);
                  });
              }
            };

            // Aplicar resaltado con mark.js en contenido
            const contentEl = document.getElementById("noteContent");
            if (contentEl) {
              const markInstance = new Mark(contentEl);
              markInstance.unmark({
                done: () => {
                  if (lastQuery) {
                    const terms = lastQuery
                      .trim()
                      .toLowerCase()
                      .split(/\s+/)
                      .filter(Boolean);
                    markInstance.mark(terms, {
                      separateWordSearch: true,
                      diacritics: true,
                      className: "highlight",
                    });
                  }
                },
              });
            }

            window.scrollTo({
              top: viewer.offsetTop - 30,
              behavior: "smooth",
            });
          })
          .catch((err) => {
            viewer.innerHTML = "<em>Error cargando nota.</em>";
            mostrarMensaje("Error cargando nota", "error");
            console.error(err);
          });
      }
    </script>
  </body>
</html>
