<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Repositorio Notas Markdown</title>

    <!-- Librerías -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mark.js/dist/mark.min.js"></script>

    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 20px;
        background: #f7f7fa;
      }
      h1 {
        font-weight: 400;
      }
      #searchBar {
        display: flex;
        gap: 10px;
        margin-bottom: 14px;
      }
      #searchInput {
        flex: 1 0 200px;
        padding: 7px 12px;
        border: 1px solid #bfc6d1;
        border-radius: 6px;
        font-size: 1em;
      }
      #btnSearch {
        padding: 7px 16px;
        border: none;
        background: #3250dd;
        color: #fff;
        font-size: 1em;
        border-radius: 6px;
        cursor: pointer;
      }
      #btnSearch:active {
        background: #263d9a;
      }
      #results {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        list-style: none;
        padding: 0;
        min-height: 42px;
      }
      .result-card {
        background: #f0f4ff;
        border-radius: 8px;
        min-width: 210px;
        max-width: 320px;
        padding: 14px 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        cursor: pointer;
        transition: box-shadow 0.15s;
        border: 1px solid #e2e8f0;
        font-size: 1.07em;
      }
      .result-card:hover {
        box-shadow: 0 4px 16px rgba(32, 64, 220, 0.15);
        border-color: #b0c4f7;
        background: #eaf0ff;
      }
      .result-card mark {
        background: #ffe570;
        padding: 1px 2px;
        border-radius: 3px;
      }
      #pagination {
        margin-top: 18px;
        font-size: 1.15em;
        user-select: none;
      }
      #pagination a,
      #pagination span {
        margin: 0 4px;
        text-decoration: none;
        color: #1a267a;
        cursor: pointer;
      }
      #pagination span.current {
        font-weight: bold;
        background: #eaf0ff;
        padding: 0 7px;
        border-radius: 4px;
      }

      /* VISOR */
      #viewer {
        margin-top: 38px;
        padding: 25px 18px;
        border: 1px solid #eee;
        border-radius: 10px;
        min-height: 170px;
        background: #fff;
        box-shadow: 0 4px 12px #eee;
        max-width: 900px;
        font-size: 1.07em;
        word-break: break-word;
        overflow-x: auto;
        position: relative; /* Para posicionar botones */
      }

      /* Botonera posición esquina superior derecha */
      .botonera {
        position: absolute;
        top: 10px;
        right: 10px;
        margin: 6px,
        display: flex;
        gap: 10px;
        z-index: 1000;
      }

      .botonera button {
        background-color: #3250dd;
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }

      .botonera button:hover {
        background-color: #263d9a;
      }

      /* Estilo para tags */
      .tags {
        margin-bottom: 14px;
      }
      .tags .tag {
        display: inline-block;
        background-color: #cce5ff;
        color: #004085;
        padding: 3px 8px;
        margin: 0 6px 6px 0;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
        user-select: none;
      }

      /* Estilos para mark.js resaltado (contenido) */
      mark {
        background-color: #ffe570;
        padding: 1px 2px;
        border-radius: 3px;
      }

      /* --- Añadimos estilos para el área de upload --- */
      #upFiles {
        margin-top: 20px;
        margin-bottom: 6px;
      }
      #actions {
        margin-bottom: 14px;
      }
      #status div {
        margin-bottom: 4px;
        font-family: monospace;
      }

      /* Mensajes de estado */
      #mensaje {
        margin-bottom: 12px;
        font-weight: bold;
      }
      #mensaje.success {
        color: green;
      }
      #mensaje.error {
        color: red;
      }

      @media (max-width: 650px) {
        #viewer,
        #results {
          max-width: 99vw;
        }
        .result-card {
          min-width: 95vw;
          max-width: 99vw;
        }
      }
    </style>
  </head>
  <body>
    <h1>Repositorio de Notas Markdown 📓 (v1.3)</h1>

    <div id="searchBar">
      <input
        type="text"
        id="searchInput"
        placeholder="Buscar en notas…"
        autocomplete="off"
      />
      <button id="btnSearch">Buscar</button>
    </div>

    <div id="pagination" style="margin-top: 16px; font-size: 1.2em"></div>

    <!-- Zona Upload -->
    <label for="upFiles" style="margin-right: 8px"
      >Upload al Repositorio ...</label
    >
    <input
      id="upFiles"
      type="file"
      accept=".md,.txt"
      multiple
      onchange="selectFiles()"
    />
    <div id="actions" style="display: none">
      <button id="uploadBtn" onclick="startUpload()">Subir ficheros</button>
    </div>
    <div id="status"></div>

    <!-- Contenedor para mensajes de respuesta -->
    <div id="mensaje"></div>

    <ul id="results"></ul>

    <div id="viewer">
      <em>Visor: Selecciona una nota para verla aquí…</em>
    </div>

    <script>
      const BACKEND = "http://localhost:5050"; //--render online
      // const BACKEND = "https://backend-101-hu0a.onrender.com"; //--render online
      const PAGE_SIZE = 3;
      let currentPage = 1;
      let lastQuery = "";

      const searchInput = document.getElementById("searchInput");
      const btnSearch = document.getElementById("btnSearch");
      const resultsUl = document.getElementById("results");
      const viewer = document.getElementById("viewer");
      const pagination = document.getElementById("pagination");

      // Variables subida
      let selectedFiles = [];

      // Buscar notas al presionar Enter o click
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") searchNotes();
      });
      btnSearch.addEventListener("click", searchNotes);

      // Gestión selección ficheros (upload)
      function selectFiles() {
        const input = document.getElementById("upFiles");
        const actions = document.getElementById("actions");
        const status = document.getElementById("status");

        selectedFiles = Array.from(input.files);
        actions.style.display = selectedFiles.length > 0 ? "block" : "none";

        // Limpiar status al seleccionar nuevos ficheros
        status.innerHTML = "";
      }

      // Función para mostrar mensajes
      function mostrarMensaje(texto, tipo = "success") {
        const mensajeElem = document.getElementById("mensaje");
        if (!mensajeElem) return;
        mensajeElem.textContent = texto;
        mensajeElem.className = tipo; // "success" o "error"

        // Ocultar mensaje luego de 5 segundos
        setTimeout(() => {
          mensajeElem.textContent = "";
          mensajeElem.className = "";
        }, 5000);
      }

      // Subir ficheros seleccionados
      async function startUpload() {
        const status = document.getElementById("status");
        status.innerHTML = "";

        for (const file of selectedFiles) {
          try {
            const content = await file.text();

            const doc = {
              filename: file.name,
              content,
            };

            const res = await fetch(`${BACKEND}/api/v1/notes/upload`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(doc),
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            if (data.status === "success") {
              const operacion = data.operacion;
              if (operacion === "insert") {
                mostrarMensaje(
                  `Nota "${doc.filename}" creada correctamente.`,
                  "success"
                );
              } else if (operacion === "update") {
                mostrarMensaje(
                  `Nota "${doc.filename}" actualizada correctamente.`,
                  "success"
                );
              }

              status.innerHTML += `<div style="color:green;">✔ ${file.name} subido correctamente</div>`;
            } else {
              mostrarMensaje(
                `Error con "${doc.filename}": ${
                  data.message || "Error desconocido"
                }`,
                "error"
              );
              status.innerHTML += `<div style="color:red;">✘ Error con ${
                file.name
              }: ${data.message || "Error desconocido"}</div>`;
            }
          } catch (e) {
            mostrarMensaje(`Error con "${file.name}": ${e.message}`, "error");
            status.innerHTML += `<div style="color:red;">✘ Error con ${file.name}: ${e.message}</div>`;
            console.error(`Error subiendo ${file.name}:`, e);
          }
        }

        // Limpiar selección y esconder botón
        selectedFiles = [];
        document.getElementById("upFiles").value = "";
        document.getElementById("actions").style.display = "none";
      }

      // Función que resalta texto en títulos (texto plano)
      function highlight(text, query) {
        if (!query) return text;
        let terms = query.toLowerCase().split(/\s+/).filter(Boolean);
        let re = new RegExp(
          "(" +
            terms
              .map((t) => t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"))
              .join("|") +
            ")",
          "gi"
        );
        return text.replace(re, "<mark>$1</mark>");
      }

      // Función de búsqueda de notas
      function searchNotes(page = 1, page_size = 5) {
        const query = searchInput.value.trim();
        document.getElementById("status").innerHTML = "";
        resultsUl.innerHTML = "<li><em>Cargando…</em></li>";
        pagination.innerHTML = "";
        viewer.innerHTML = "<em>Selecciona una nota para verla aquí…</em>";
        lastQuery = query;
        currentPage = page;

        fetch(
          `${BACKEND}/api/v1/notes/search?q=${encodeURIComponent(
            query
          )}&page=${page}&page_size=${PAGE_SIZE}&mode=page`
        )
          .then((r) => r.json())
          .then((result) => {
            resultsUl.innerHTML = "";
            if (!result.data || result.data.length === 0) {
              resultsUl.innerHTML = "<li><em>No hay resultados.</em></li>";
              renderPagination(0, 1, pageSize, query, {});
              return;
            }

            result.data.forEach((note) => {
              const li = document.createElement("li");
              li.className = "result-card";
              li.innerHTML = note._id + "- " + highlight(note.title, query);
              li.dataset.id = note._id;
              li.onclick = () => loadNote(note._id);
              resultsUl.appendChild(li);
            });

            // renderPagination(data.total, page, data.pageSize, query);
            renderPagination(
              result.pagination.total,
              result.pagination.page,
              result.pagination.page_size,
              query,
              result.links
            );
          })
          .catch((err) => {
            resultsUl.innerHTML = "<li><em>Error buscando notas…</em></li>";
            console.error(err);
          });
      }

      // Paginación
      function renderPagination(total, currentPage, pageSize, query, links) {
        pagination.innerHTML = "";

        // Prev button
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Anterior";
        prevBtn.disabled = !links.prev;
        if (links.prev) {
          prevBtn.onclick = () => fetchByUrl(links.prev);
        }
        pagination.appendChild(prevBtn);

        // Page info
        const info = document.createElement("span");
        info.textContent = `Página ${currentPage} de ${Math.ceil(
          total / pageSize
        )}`;
        pagination.appendChild(info);

        // Next button
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Siguiente";
        nextBtn.disabled = !links.next;
        if (links.next) {
          nextBtn.onclick = () => fetchByUrl(links.next);
        }
        pagination.appendChild(nextBtn);
      }

      function fetchByUrl(url) {
        // Creamos un objeto URL para extraer los params
        const absolute = url.startsWith("http")
          ? url
          : window.location.origin + url;
        const searchParams = new URL(absolute).searchParams;
        const page = searchParams.get("page")
          ? parseInt(searchParams.get("page"), 10)
          : 1;
        const page_size = searchParams.get("page_size")
          ? parseInt(searchParams.get("page_size"), 10)
          : 5;
        searchNotes(page, page_size);
      }

      // Carga nota y la muestra con resaltado en título y contenido
      function loadNote(id) {
        viewer.innerHTML = "<em>Cargando nota…</em>";
        fetch(`${BACKEND}/api/v1/notes/${id}`)
          .then((res) => res.json())
          .then((result) => {
            console.log("result", result);
            const note = result.data;
            console.log("note", note);
            const tagsHtml =
              note.tags && note.tags.length > 0
                ? `<div class="tags">${note.tags
                    .map((tag) => `<span class="tag">${tag}</span>`)
                    .join("")}</div>`
                : "";

            // Botonera posicionada en la esquina superior derecha
            viewer.innerHTML = `
              <div class="botonera">
                <button id="editTitleBtn">Editar título</button>
                <button id="deleteNoteBtn">Borrar nota</button>
                <button id="downloadMdBtn">Descargar .md</button>
              </div>
              ${tagsHtml}
              <div id="noteContent">${marked.parse(note.content)}</div>
            `;

            // Descargar .md
            document.getElementById("downloadMdBtn").onclick = function () {
              const blob = new Blob([note.content], { type: "text/markdown" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download =
                note.filename || note.title.replace(/\s+/g, "_") + ".md";
              document.body.appendChild(a);
              a.click();
              setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              }, 100);
            };

            // EDITAR TÍTULO
            document.getElementById("editTitleBtn").onclick = () => {
              const newTitle = prompt("Editar título de la nota:", note.title);
              if (
                newTitle &&
                newTitle.trim() !== "" &&
                newTitle !== note.title
              ) {
                fetch(`${BACKEND}/api/notes/${id}`, {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ title: newTitle.trim() }),
                })
                  .then((res) => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                  })
                  .then((updatedNote) => {
                    mostrarMensaje("Título actualizado", "success");
                    loadNote(id); // recarga nota con título editado
                    searchNotes(currentPage); // refresca la lista para mostrar nuevo título
                  })
                  .catch((err) => {
                    mostrarMensaje("Error actualizando título", "error");
                    console.error(err);
                  });
              }
            };

            // BORRAR NOTA
            document.getElementById("deleteNoteBtn").onclick = () => {
              if (
                confirm(
                  "¿Estás seguro de querer borrar esta nota? Esta acción no se puede deshacer."
                )
              ) {
                fetch(`${BACKEND}/api/notes/${id}`, {
                  method: "DELETE",
                })
                  .then((res) => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    mostrarMensaje("Nota borrada correctamente", "success");
                    viewer.innerHTML =
                      "<em>Selecciona una nota para verla aquí…</em>";
                    searchNotes(currentPage); // refresca listado
                  })
                  .catch((err) => {
                    mostrarMensaje("Error borrando la nota", "error");
                    console.error(err);
                  });
              }
            };

            // Aplicar resaltado con mark.js en contenido
            const contentEl = document.getElementById("noteContent");
            if (contentEl) {
              const markInstance = new Mark(contentEl);

              markInstance.unmark({
                done: () => {
                  if (lastQuery) {
                    const terms = lastQuery
                      .trim()
                      .toLowerCase()
                      .split(/\s+/)
                      .filter(Boolean);
                    markInstance.mark(terms, {
                      separateWordSearch: true,
                      diacritics: true,
                      className: "highlight",
                    });
                  }
                },
              });
            }

            window.scrollTo({ top: viewer.offsetTop - 30, behavior: "smooth" });
          })
          .catch((err) => {
            viewer.innerHTML = "<em>Error cargando nota.</em>";
            mostrarMensaje("Error cargando nota", "error");
            console.error(err);
          });
      }

      // Puedes descomentar para lanzar búsqueda al cargar la página
      // searchNotes();
    </script>
  </body>
</html>
